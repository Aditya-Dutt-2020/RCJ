This is all of the final encoder code
